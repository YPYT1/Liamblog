---
import BaseLayout from '@/layouts/BaseLayout.astro'
import Comments from '@/components/Comments'
import { dbAll, dbGet } from '@/lib/db'
import { parseTags, readingTime, extractHeadings, addHeadingIds } from '@/lib/content'

const { slug } = Astro.params
const env = Astro.locals.runtime.env
const preview = Astro.url.searchParams.get('preview') === '1'
const isAdmin = Astro.locals.user?.role === 'admin'
const allowDraft = preview && isAdmin

const post = await dbGet<{
  id: string
  title: string
  summary: string | null
  content_html: string
  cover_image: string | null
  published_at: string | null
  updated_at: string
  tags: string | null
  category: string | null
  series: string | null
  status: string
}>(
  env.DB,
  allowDraft
    ? 'SELECT id, title, summary, content_html, cover_image, published_at, updated_at, tags, category, series, status FROM posts WHERE slug = ? LIMIT 1'
    : 'SELECT id, title, summary, content_html, cover_image, published_at, updated_at, tags, category, series, status FROM posts WHERE slug = ? AND status = ? LIMIT 1',
  allowDraft ? [slug] : [slug, 'published'],
)

if (!post || post.status === 'deleted') {
  throw new Response('Not found', { status: 404 })
}

if (!allowDraft && post.status !== 'published') {
  throw new Response('Not found', { status: 404 })
}

const tags = parseTags(post.tags)
const contentHtml = addHeadingIds(post.content_html)
const read = readingTime(contentHtml)
const headings = extractHeadings(contentHtml)

let related: { slug: string; title: string; summary?: string }[] = []
if (post.category || tags.length) {
  const like = tags[0] ? `%${tags[0]}%` : '%'
  related = await dbAll(
    env.DB,
    `SELECT slug, title, summary FROM posts
     WHERE status = 'published' AND id != ? AND (category = ? OR tags LIKE ?)
     ORDER BY published_at DESC LIMIT 4`,
    [post.id, post.category ?? '', like],
  )
}
if (related.length === 0) {
  related = await dbAll(
    env.DB,
    'SELECT slug, title, summary FROM posts WHERE status = ? AND id != ? ORDER BY published_at DESC LIMIT 4',
    ['published', post.id],
  )
}

const seriesItems = post.series
  ? await dbAll<{ id: string; slug: string; title: string; status: string }>(
      env.DB,
      `SELECT id, slug, title, status FROM posts WHERE series = ? ${allowDraft ? '' : "AND status = 'published'"}
       ORDER BY published_at ASC, created_at ASC`,
      [post.series],
    )
  : []
const currentIndex = seriesItems.findIndex((item) => item.id === post.id)
const prevItem = currentIndex > 0 ? seriesItems[currentIndex - 1] : null
const nextItem = currentIndex >= 0 && currentIndex < seriesItems.length - 1 ? seriesItems[currentIndex + 1] : null
---
<BaseLayout title={post.title} description={post.summary || ''}>
  <section class="mx-auto max-w-6xl px-4 py-10 lg:grid lg:grid-cols-[minmax(0,1fr)_240px] lg:gap-10">
    <div>
      <article class="mx-auto max-w-3xl lg:mx-0">
        {post.status !== 'published' && (
          <div class="mb-6 rounded-xl border border-amber-200 bg-amber-50/70 px-4 py-3 text-xs text-amber-700">
            草稿预览中，仅管理员可见。
          </div>
        )}
        {post.cover_image && (
          <div class="mb-6 overflow-hidden rounded-2xl border border-black/5">
            <img src={post.cover_image} alt={post.title} class="h-64 w-full object-cover" loading="lazy" />
          </div>
        )}
        <div class="text-xs uppercase tracking-[0.3em] text-slate-400">Blog</div>
        <h1 class="mt-3 text-3xl font-semibold text-slate-900">{post.title}</h1>
        {post.summary && <p class="mt-3 text-sm text-slate-600">{post.summary}</p>}
        <div class="mt-3 flex flex-wrap items-center gap-2 text-xs text-slate-500">
          <span>{post.published_at || post.updated_at}</span>
          <span>{read.minutes} min read</span>
          {post.category && <span class="rounded-full bg-black/5 px-2 py-0.5">{post.category}</span>}
          {post.series && <span class="rounded-full bg-black/5 px-2 py-0.5">系列：{post.series}</span>}
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          {tags.map((tag) => (
            <a class="text-xs text-slate-500 transition hover:text-slate-800" href={`/blog/tags/${encodeURIComponent(tag)}`}>
              #{tag}
            </a>
          ))}
        </div>
        <div class="prose prose-slate mt-8 max-w-none" set:html={contentHtml} />
      </article>

      {post.status === 'published' && <Comments targetType="post" targetId={post.id} client:only="react" />}

      {related.length > 0 && (
        <div class="mt-12">
          <h3 class="text-lg font-semibold">相关文章</h3>
          <div class="mt-4 grid gap-3 md:grid-cols-2">
            {related.map((item) => (
              <a class="glass-card p-4 transition hover:-translate-y-0.5" href={`/blog/${item.slug}`}>
                <div class="text-sm font-medium text-slate-800">{item.title}</div>
                {item.summary && <div class="mt-2 text-xs text-slate-500">{item.summary}</div>}
              </a>
            ))}
          </div>
        </div>
      )}
    </div>

    <aside class="hidden lg:block">
      <div class="sticky top-28 space-y-6">
        {headings.length > 0 && (
          <div class="glass-card p-4">
            <div class="text-xs uppercase tracking-[0.3em] text-slate-400">目录</div>
            <ul class="mt-3 space-y-2 text-sm text-slate-600">
              {headings.map((item) => (
                <li class={item.level === 3 ? 'pl-3 text-xs' : ''}>
                  <a class="transition hover:text-slate-900" href={`#${item.id}`}>
                    {item.text}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        )}
        {post.series && seriesItems.length > 1 && (
          <div class="glass-card p-4">
            <div class="text-xs uppercase tracking-[0.3em] text-slate-400">系列导航</div>
            <div class="mt-3 space-y-2 text-sm text-slate-600">
              {prevItem && (
                <a class="block transition hover:text-slate-900" href={`/blog/${prevItem.slug}`}>
                  ← {prevItem.title}
                </a>
              )}
              {nextItem && (
                <a class="block transition hover:text-slate-900" href={`/blog/${nextItem.slug}`}>
                  {nextItem.title} →
                </a>
              )}
            </div>
          </div>
        )}
      </div>
    </aside>
  </section>
</BaseLayout>
