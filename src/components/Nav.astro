---
import ThemeToggle from '@/components/ThemeToggle'
const user = Astro.locals.user

const rawLabel = user?.display_name || user?.email || ''
const navLabel = user
  ? rawLabel.includes('@')
    ? rawLabel.slice(0, 4)
    : rawLabel
  : '登录'
const avatarUrl = user?.avatar_url || ''
const avatarFallback = (navLabel || 'U').slice(0, 2).toUpperCase()

const navItems = [
  { label: '博客', href: '/blog' },
  { label: '项目', href: '/project' },
  { label: '关于', href: '/about' },
  { label: '文档', href: '/docs' },
  { label: '搜索', href: '/search' },
]

const moreItems = [
  { label: '归档', href: '/blog/archive' },
  { label: '留言箱', href: '/guestbook' },
  ...(user?.role === 'admin' ? [{ label: '后台', href: '/Liam/admin' }] : []),
]

const authItem = { label: navLabel || (user ? '账号' : '登录'), href: '/auth' }
---

<header class="sticky top-0 z-50 w-full border-b border-black/5 bg-white/80 backdrop-blur-md dark:border-white/5 dark:bg-black/80">
  <div class="mx-auto flex h-16 max-w-[1400px] items-center justify-between px-6">
    
    {/* 1. 左侧 Logo 区域 */}
    <div class="flex shrink-0 items-center">
      <a class="flex items-center gap-3 text-sm font-medium transition hover:opacity-80" href="/">
        <span class="grid h-8 w-8 place-items-center rounded-full bg-slate-100 text-xs font-bold text-slate-700 dark:bg-white/10 dark:text-slate-200">LW</span>
        <span class="text-base tracking-wide text-slate-900 dark:text-white">Liam Wang</span>
      </a>
    </div>

    {/* 2. 中间导航链接 - 仅在大屏显示，绝对居中或靠左 */}
    <nav class="hidden items-center gap-8 md:flex">
      {navItems.map((item) => (
        <a class="text-sm font-medium text-slate-500 transition hover:text-slate-900 dark:text-slate-400 dark:hover:text-white" href={item.href}>
          {item.label}
        </a>
      ))}
      
      {/* 更多菜单 - 修复 Hover 问题 */}
      <div class="group relative flex h-full items-center">
        <button type="button" class="flex items-center gap-1 text-sm font-medium text-slate-500 transition group-hover:text-slate-900 dark:text-slate-400 dark:group-hover:text-white">
          更多
          <span class="text-[10px] opacity-50">▼</span>
        </button>
        
        {/* 下拉菜单容器：使用 pt-4 作为透明桥梁，消除间隙 */}
        <div class="invisible absolute left-1/2 top-full min-w-[160px] -translate-x-1/2 pt-4 opacity-0 transition-all duration-200 group-hover:visible group-hover:translate-y-0 group-hover:opacity-100 motion-safe:translate-y-2">
          <div class="overflow-hidden rounded-xl border border-black/5 bg-white p-1.5 shadow-xl ring-1 ring-black/5 dark:border-white/10 dark:bg-[#1a1a1a] dark:ring-white/10">
            {moreItems.map((item) => (
              <a class="block rounded-lg px-3 py-2 text-sm text-slate-600 transition hover:bg-slate-50 hover:text-slate-900 dark:text-slate-300 dark:hover:bg-white/10 dark:hover:text-white" href={item.href}>
                {item.label}
              </a>
            ))}
          </div>
        </div>
      </div>
    </nav>

    {/* 3. 右侧功能区 */}
    <div class="flex shrink-0 items-center gap-4">
      <a
        class="flex items-center gap-2 text-sm font-medium text-slate-600 transition hover:text-slate-900 dark:text-slate-300 dark:hover:text-white"
        href={authItem.href}
      >
        {user ? (
          <>
            {avatarUrl ? (
              <img src={avatarUrl} alt={authItem.label} class="h-7 w-7 rounded-full object-cover ring-1 ring-black/10" />
            ) : (
              <span class="grid h-7 w-7 place-items-center rounded-full bg-slate-200 text-[11px] font-semibold text-slate-700">
                {avatarFallback}
              </span>
            )}
            <span>{authItem.label}</span>
          </>
        ) : (
          <span>{authItem.label}</span>
        )}
      </a>
      {/* 垂直分割线 */}
      <div class="h-4 w-px bg-slate-200 dark:bg-white/10"></div>
      <ThemeToggle client:only="react" />
    </div>

  </div>
</header>
