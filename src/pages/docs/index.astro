---
import BaseLayout from '@/layouts/BaseLayout.astro'
import { dbAll } from '@/lib/db'
import { slugify } from '@/lib/content'

const env = Astro.locals.runtime.env
const page = Math.max(1, Number(Astro.url.searchParams.get('page') || '1'))
const pageSize = 12
const offset = (page - 1) * pageSize
const docs = await dbAll(
  env.DB,
  'SELECT id, slug, title, summary, order_index, category, series FROM docs WHERE status = ? ORDER BY order_index ASC, published_at DESC LIMIT ? OFFSET ?',
  ['published', pageSize, offset],
)
const totalRows = await dbAll<{ total: number }>(env.DB, 'SELECT COUNT(*) as total FROM docs WHERE status = ?', [
  'published',
])
const total = (totalRows[0] as unknown as { total: number })?.total ?? 0
const totalPages = Math.max(1, Math.ceil(total / pageSize))

const grouped = new Map<string, typeof docs>()
for (const doc of docs) {
  const key = doc.category || '未分类'
  if (!grouped.has(key)) grouped.set(key, [])
  grouped.get(key)!.push(doc)
}
const categories = Array.from(grouped.keys())
---
<BaseLayout title="文档" description="Liam 的文档">
  <section class="mx-auto max-w-6xl px-4 py-10 lg:grid lg:grid-cols-[minmax(0,1fr)_220px] lg:gap-10">
    <div>
      <h1 class="text-2xl font-semibold">文档</h1>
      <p class="mt-2 text-sm text-slate-600">整理成体系的知识与笔记。</p>
      <div class="mt-4 flex flex-wrap gap-3 text-sm text-slate-500">
        <a class="underline" href="/docs/tags">标签</a>
        <a class="underline" href="/docs/categories">分类</a>
        <a class="underline" href="/docs/series">系列</a>
      </div>

      <div class="mt-8 space-y-6">
        {docs.length === 0 && (
          <div class="glass-card p-6 text-sm text-slate-600">暂无文档，先去后台写一篇吧。</div>
        )}
        {categories.map((category) => (
          <div id={`cat-${slugify(category)}`} class="space-y-3">
            <div class="flex items-center gap-3">
              <div class="text-xs uppercase tracking-[0.3em] text-slate-400">Category</div>
              <h2 class="text-base font-semibold">{category}</h2>
            </div>
            <div class="space-y-3">
              {grouped.get(category)?.map((doc) => (
                <a href={`/docs/${doc.slug}`} class="glass-card block p-5 transition hover:-translate-y-1">
                  <h3 class="text-base font-semibold">{doc.title}</h3>
                  {doc.summary && <p class="mt-2 text-sm text-slate-600">{doc.summary}</p>}
                  {doc.series && <div class="mt-2 text-xs text-slate-500">系列：{doc.series}</div>}
                </a>
              ))}
            </div>
          </div>
        ))}
      </div>
      {totalPages > 1 && (
        <div class="mt-8 flex items-center justify-between text-sm text-slate-500">
          <a class={page <= 1 ? 'pointer-events-none opacity-40' : ''} href={`/docs?page=${page - 1}`}>
            上一页
          </a>
          <span>
            {page} / {totalPages}
          </span>
          <a class={page >= totalPages ? 'pointer-events-none opacity-40' : ''} href={`/docs?page=${page + 1}`}>
            下一页
          </a>
        </div>
      )}
    </div>

    <aside class="hidden lg:block">
      <div class="sticky top-28 space-y-4">
        <div class="glass-card p-4">
          <div class="text-xs uppercase tracking-[0.3em] text-slate-400">目录导航</div>
          <div class="mt-3 space-y-2 text-sm text-slate-600">
            {categories.map((category) => (
              <a class="block transition hover:text-slate-900" href={`#cat-${slugify(category)}`}>
                {category}
              </a>
            ))}
          </div>
        </div>
        <div class="glass-card p-4">
          <div class="text-xs uppercase tracking-[0.3em] text-slate-400">阅读建议</div>
          <p class="mt-3 text-sm text-slate-600">从目录开始，一层层整理你的知识体系。</p>
        </div>
      </div>
    </aside>
  </section>
</BaseLayout>
